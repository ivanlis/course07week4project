---
title: "Analysis of Miles per Gallon for Manual and Automatic Transmission"
author: "Ivan Lysiuchenko"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



## Executive summary


## Initial exploratory data analysis

```{r echo=FALSE, message=FALSE}
library(dplyr)
library(GGally)
cardata <- mtcars
cardata <- mutate(cardata, 
                  cyl = factor(as.character(cyl)),
                  vs = factor(as.character(vs)),
                  am = factor(as.character(am)),
                  carb = factor(as.character(carb))
                  )
meanAuto <- mean(cardata[cardata$am == 0, "mpg"])
meanManual <- mean(cardata[cardata$am == 1, "mpg"])
```

Let's start taking a look at interactions between the predictors and outcome.
One of the panels present in the pairs plot (Figure 1 of the Appendix) and a direct
calculation show that really there is a better mean miles per gallon (mpg)
value for manual transmission (`r meanManual`) than for auto (`r meanAuto`).

Other aspects we notice are some patterns looking like linear relationships,
between the outcome (mpg) and some variables, e.g. disp, hp, wt.

## Research on the role of transmission type

Some variables take discrete values, so we treat them as factor variables:
cyl, vs, am, gear, carb. The cardata structure mentioned in the code chunks
that follow is the same as mtcars, but the mentioned columns have been converted 
into factors. If we just fit the mpg as a function of am, we don't get anything interesting. The estimates would be the mean mpg values for the two groups of cars
formed by differentiating their transmission type.Maybe, we can get some insight
looking at a complete model, where all the variables are used as predictors:

```{r echo=TRUE, eval=FALSE}
modelComplete <- lm(data = cardata, formula = mpg ~ .)
```

Analyzing the pvalues, we can say that there are no coefficients significant
with Type I error probability of 0.05. Only two of them, hp (horsepower)
and wt (weight) are somehow close to be significant. Let's take one of them 
to include in the model we fitted for am as a predictor:

```{r}
modelAmWt <- lm(data = cardata, formula = mpg ~ am + wt)
summary(modelAmWt)$coefficients[2, ]
```

It turns out that the inclusion of weight makes the coefficient for am insignificant
with a very high p-value. Let's look at a plot showing how mpg depends on wt. We'll
use color to mark data for automatic (0) and manual (1) transmission.

```{r}
g <- ggplot(data.frame(wt = cardata$wt, mpg = cardata$mpg, am = cardata$am), 
            aes(x = wt, y = mpg, color = am)) + geom_point() + 
    labs(x = "weight, 1000 lbs", y = "miles per gallon",
         title = "Miles per gallon as a function of weight")
```

It follows that according to our data, automatic transmission is generally 
installed on heavier cars. Therefore, wt appears as a confounding variable rendering
insignificant the difference based on the 'auto'/'manual' grouping.


## Building a model

Let's take wt and hp as predictors and build two models: (1) only wt and hp 
linear combination; (2) wt, hp and their interaction term. Their analysis as
nested models with ANOVA shows that the interaction has a significant importance.

```{r}
modelWtHp <- lm(data = cardata, formula = mpg ~ wt + hp)
modelWtHpInteraction <- lm(data = cardata, formula = mpg ~ wt * hp)
anova(modelWtHp, modelWtHpInteraction)
```

We choose the model with interaction to explain the mpg of the cars from our data.
All its coefficients are significant with low p-values.
It can be shown with ANOVA that including any other variable to our model does not produce a significant result. Let's interpret the coefficients. When the car's weight
increases by 1000 lbs, its miles per gallon change by 
`r modelWtHpInteraction$coefficients[2]` (decrease). When the car gets 1 hp more
powerful, its miles per gallon change by `r modelWtHpInteraction$coefficients[3]`
(decrease). When the product of the two changes by 1000 (lbs * hp), the miles
per gallon increase by `r modelWtHpInteraction$coefficients[4]`.

```{r}
summary(modelWtHpInteraction)$coefficients
```



## Appendix

```{r message=FALSE, echo=FALSE}
#library(GGally)
#ggpairs(mtcars, upper = list(continuous = "points", combo="dot_no_facet")) + 
#    labs(title = "Pairs plot")
```


```{r}


#g <- ggplot(data.frame(wt = cardata$wt, hp = cardata$hp, am = cardata$am), aes(x = hp, 
#y = wt, color = am)) + geom_point()



#g <- ggplot(data = data.frame(mpg = cardata$mpg, residWtHp = resid(modelWtHp), residWtHpInteraction = resid(modelWtHpInteraction), residAmHp = resid(modelAmHp))) + geom_line(aes(x = mpg, y = residWtHp), color = "blue") + geom_line(aes(x = mpg, y = residWtHpInteraction), color = "red") + geom_line(aes(x = mpg, y = residAmHp), color = "green")

```


```{r}
#modelAm <- lm(data = cardata, formula = mpg ~ am)






#g <- ggplot(data.frame(x = cardata$mpg, y = resid(modelWtHpInteraction), am = 
#cardata$am), aes(x = x, y = y, color = am)) + geom_point()
```